define(["require","exports","core/NodeList","core/NodePool","core/IFamily","tools/Dictionary"],function(n,t,i,r,u,f){var o=i,s=r,c=u,e=f,h;(function(n){(function(n){var t=function(){function n(n,t){var r,i,u;this._nodeClass=n,this._engine=t,this._nodePool=new s.ash.core.NodePool(this._nodeClass),this._nodes=new o.ash.core.NodeList,this._entities=new e.ash.tools.Dictionary,this._components=new e.ash.tools.Dictionary,this._nodePool.dispose(this._nodePool.get()),r=this._nodeClass.prototype;for(i in r)r.hasOwnProperty(i)&&i!="types"&&i!="next"&&i!="previous"&&i!="constructor"&&i!="super"&&i!="extend"&&i!="entity"&&(u=r.types[i],this._components.add(u,i));this._init()}return n.prototype._init=function(){},n.prototype.nodeList=function(){return this._nodes},n.prototype.newEntity=function(n){this.addIfMatch(n)},n.prototype.componentAddedToEntity=function(n){this.addIfMatch(n)},n.prototype.componentRemovedFromEntity=function(n,t){this._components.has(t)&&this.removeIfMatch(n)},n.prototype.removeEntity=function(n){this.removeIfMatch(n)},n.prototype.addIfMatch=function(n){var t,i;if(!this._entities.getValue(n)){for(t in this._components)if(!n.has(t))return;i=this._nodePool.get(),i.entity=n;for(t in this._components)i[this._components[t]]=n.get(t);this._entities.add(n,i),this._nodes.add(i)}},n.prototype.removeIfMatch=function(n){if(this._entities.getValue(n)){var t=this._entities.getValue(n);this._entities.remove(n),this._nodes.remove(t),this._engine.updating?(this._nodePool.cache(t),this._engine.updateComplete.add(this._releaseNodePoolCache,this)):this._nodePool.dispose(t)}},n.prototype._releaseNodePoolCache=function(){this._engine.updateComplete.remove(this._releaseNodePoolCache),this._nodePool.releaseCache()},n.prototype.cleanUp=function(){for(var n=this._nodes.head;n;n=n.next)this._entities.remove(n.entity);this._nodes.removeAll()},n}();n.ComponentMatchingFamily=t})(n.core||(n.core={}));var t=n.core})(t.ash||(t.ash={})),h=t.ash})